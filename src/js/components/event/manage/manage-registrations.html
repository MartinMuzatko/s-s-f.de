<manage-registrations>
    <div>

    </div>
    <p>Aktion für <strong>{getMarkedUsersAmount()}</strong> markierte</p>
    <h4>Registrierter Status</h4>
    <div class="actions">
        <button onclick={setMarkedUserStatus} data-status="new" class="button button--primary">Auf Neu setzen</button>
        <button onclick={setMarkedUserStatus} data-status="pending" class="button button--primary">Auf Bezahlung ausstehend setzen</button>
        <button onclick={setMarkedUserStatus} data-status="accepted" class="button button--primary">Auf Akzeptiert setzen</button>
        <button onclick={setMarkedUserStatus} data-status="waiting" class="button button--primary">Auf Warteliste setzen</button>
        <button onclick={setMarkedUserStatus} data-status="signedoff" class="button button--primary">Auf Abgemeldet setzen</button>
        <button onclick={setMarkedUserStatus} data-status="dismissed" class="button button--primary">Auf Verbannt setzen</button>
    </div>
    <h4>Rollen filtern</h4>
    <div class="actions">
        <div each={role in attendeeRoles}>

        </div>
    </div>
    <table>
        <thead>
            <th><input onchange={checkAll} type="checkbox"></th>
            <th onclick={sortByField} each={label in labels}>
                {label.name}
                <span if={sortMode == label.name}>V</span>
                <span if={sortMode == '-'+label.name}>^</span>
                <span if={!~sortMode.indexOf(label.name)}>-</span>
            </th>
        </thead>
        <tbody>
            <tr each={user in users}>
                <td><input onchange={selectUser} type="checkbox" checked={user.checked}></td>
                <td>
                    <div layout="row" layout-align="start center">
                        <img class="avatar avatar--small avatar--round" style="margin-right: .5em" src="{user.profile.avatar}" alt="{user.profile.username}">
                        {user.profile.username}
                        {user.donation ? '(Sponsor)' : ''}
                    </div>
                </td>
                <td style={getPaidThreshold(user)}>
                    {getUserRegdate(user) == -1 ? '✓' : getUserRegdate(user)}
                    <span if={user.warningsReceived} title="{lastWarningReceived(user)} seit letzter Warnung">
                        - {lastWarningReceived(user)}
                    </span>
                </td>
                <td>
                    <div layout="row" layout-align="space-between" layout-nowrap>
                        {user.warningsReceived}
                        <div title="{user.warningsReceived+1 }. Mahnung erteilen" onclick={sendWarning} if={canWarnUser(user)} class="bg--warning bg--warning--shadow status-bubble warning-bubble">
                            !
                        </div>
                    </div>  
                </td>
                <td class="text--nowrap">{moneyFormat.to(user.paysum)}</td>
                <td>
                    <img each={role in user.attendeeRoles} title="{role.title}" src="{role.image}" alt="" width="32">
                </td>
                <td><ssf-toggle ref="statusSwitch" user="{user}" disabled={user.attendeeStatus == 'new'} data-status="new" active={user.attendeeStatus == 'new'}></ssf-toggle></td>
                <td><ssf-toggle ref="statusSwitch" user="{user}" disabled={user.attendeeStatus == 'pending'} data-status="pending" active={user.attendeeStatus == 'pending'}></ssf-toggle></td>
                <td><ssf-toggle ref="statusSwitch" user="{user}" disabled={user.attendeeStatus == 'accepted'} data-status="accepted" active={user.attendeeStatus == 'accepted'}></ssf-toggle></td>
                <td><ssf-toggle ref="statusSwitch" user="{user}" disabled={user.attendeeStatus == 'waiting'} data-status="waiting" active={user.attendeeStatus == 'waiting'}></ssf-toggle></td>
                <td><ssf-toggle ref="statusSwitch" user="{user}" disabled={user.attendeeStatus == 'signedoff'} data-status="signedoff" active={user.attendeeStatus == 'signedoff'}></ssf-toggle></td>
                <td><ssf-toggle ref="statusSwitch" user="{user}" disabled={user.attendeeStatus == 'dismissed'} data-status="dismissed" active={user.attendeeStatus == 'dismissed'}></ssf-toggle></td>
            </tr>
        </tbody>
    </table>
    <button disabled={submissionLoading} onclick={submit} class="button button--primary">
        Übernehmen
    </button>
    <div>
        <ssf-pawloader if={submissionLoading}></ssf-pawloader>
    </div>
    <div if={submissionComplete && !submissionLoading} class="notification notification--success">
        Die Daten wurden erfolgreich übernommen.
    </div>
    <user-message-send message={warningMessage} ref="warningMessage"></user-message-send>
    <script>
        import differenceInDays from 'date-fns/difference_in_days'
        import { moneyFormat } from '../../../constants'
        import { getRegistrations, updateRegistrations, getEventData, warnUser } from '../../../api'
        import '../../ssf-toggle.html'
        import '../../ssf-pawloader.html'
        import '../../ssf-dialog.html'
        import '../../user/user-message-send.html'
        
        const STATUS_NEW = 'new'
        const STATUS_PENDING = 'pending'
        const STATUS_ACCEPTED = 'accepted'
        const STATUS_WAITING = 'waiting'
        const STATUS_SIGNEDOFF = 'signedoff'
        const STATUS_DISMISSED = 'dismissed'

        const STATUS = {
            [STATUS_NEW]: 'Neu',
            [STATUS_PENDING]: 'Zahlung ausstehend',
            [STATUS_ACCEPTED]: 'Bezahlt',
            [STATUS_WAITING]: 'Warteliste',
            [STATUS_SIGNEDOFF]: 'Abgemeldet',
            [STATUS_DISMISSED]: 'Verbannt',
        }
        
        this.users = []
        this.submissionLoading = false
        this.maxDays = 28
        this.maxWarningDays = 14

        async submit() {
            try {
                this.submissionLoading = true
                this.update()
                await updateRegistrations(opts.event, this.users)
                this.submissionComplete = true
                this.submissionDetails = []
            } catch (error) {
                this.submissionComplete = false
            }
            this.submissionLoading = false
            this.update()
        }

        async getRegistrations() {
            this.users = await getRegistrations(opts.event)
            this.users.forEach(
                user => {
                    user.checked = false
                    user.modified = parseInt(user.modified)
                    user.created = parseInt(user.created)
                    user.lastWarning = parseInt(user.lastWarning)
                }
            )
        }
        
        this.on('mount', async () => {
            const [users, event] = await Promise.all([
                await this.getRegistrations(),
                await getEventData(opts.event),
            ])
            this.event = event
            this.attendeeRoles = [...new Set(this.users.reduce((roles, user) => [...roles, ...user.attendeeRoles], []))]
            this.update()
            this.refs.statusSwitch.map(toggle=>{
                toggle.on('toggle', (status)=>{
                    toggle.opts.user.attendeeStatus = toggle.opts.dataStatus
                    this.update()
                })
            })
        })

        getMarkedUsersAmount() {
            return this.getMarkedUsers().length
        }
        
        setMarkedUserStatus(e) {
            this.getMarkedUsers().map(user=>{user.attendeeStatus=e.target.dataset.status})
        }
        
        getMarkedUsers() {
            return this.users.filter(user=>user.checked)
        }

        sendWarning(e) {
            const user = e.item.user
            const event = this.event
            let deadline = new Date()
            deadline = deadline.fp_incr(14) // flatpickr extends the date prototype with this function to add days.
            let deadlineDate = `${deadline.getDate()}.${deadline.getMonth()+1}.${deadline.getFullYear()}`
            this.warningMessage = {
                text: `
                    <p>Hallo ${user.profile.username}!</p>
                    <p>Leider konnten wir von dir noch keinen Zahlungseingang für das Event vermerken.</p>
                    <p>Wir bitten dich, innerhalb von 2 Wochen (bis ${deadlineDate}) den Betrag von ${moneyFormat.to(user.paysum)} auf das untenstehende Konto zu überweisen.</p>
                    <strong>Empfänger:</strong> ${event.bankAccountName}<br>
                    <strong>IBAN:</strong> ${event.bankIBAN}<br>
                    <strong>BIC:</strong> ${event.bankBIC}<br>
                    <strong>Betrag:</strong> ${moneyFormat.to(user.paysum)}<br>
                    <strong>Betreff:</strong> ${event.title} - ${user.profile.username}<br>
                    <strong>Adresse für Auslandsüberweisungen:</strong><br> ${event.bankAccountAddress}<br>
                    <p>Solltest du Probleme mit der Bezahlung haben, bitte melde dich beim Team.</p>
                    <p>Wir finden immer eine Lösung.</p>
                    <p>Vielen Dank.<br>Dein Eventteam.
                    </p>
                `,
                title: `Zahlungserinnerung für ${event.title}`,
                receiver: e.item.user.profile.username,
            }
            this.refs.warningMessage.open(this.warningMessage)
            console.log('opened')
            this.refs.warningMessage.one('sent', async message => {
                console.log('warn user')
                Object.assign(message, {type: 'paymentReminder'})
                await warnUser(this.opts.event, user.profile.name, message)
                await this.getRegistrations()
                this.update()
            })
        }

        getUserRegdate(user) {
            if (user.attendeeStatus == STATUS_PENDING) {
                return differenceInDays(new Date(), user.created)
            } else if (user.attendeeStatus == STATUS_ACCEPTED) {
                return -1
            } else {
                return '-'
            }
        }

        lastWarningReceived(user) {
            return user.warningsReceived ? differenceInDays(new Date(), user.lastWarning) : 0
        }

        canWarnUser(user) {
            if (!user.warningsReceived) {
                return differenceInDays(new Date(), user.created) > this.maxDays
            }
            return this.lastWarningReceived(user) > this.maxWarningDays
        }

        getPaidThreshold(user) {
            if (user.attendeeStatus == STATUS_ACCEPTED) {
                return `background-color: hsl(180, 50%, 70%)`
            } else if (user.attendeeStatus == STATUS_NEW) {
                return `background-color: hsl(120, 50%, 70%)`
            } else if (user.attendeeStatus == STATUS_PENDING) {
                let hueGradient = [0, 120]
                if (user.warningsReceived) {
                    let hue = hueGradient[0] + hueGradient[1] / this.maxWarningDays * (this.maxWarningDays - Math.min(this.lastWarningReceived(user), this.maxWarningDays))
                    let background = `background-color: hsl(${hue}, 50%, 50%)`
                    return background
                }

                let hue = hueGradient[0] + hueGradient[1] / this.maxDays * (this.maxDays - Math.min(differenceInDays(new Date(), user.created), this.maxDays))
                let background = `background-color: hsl(${hue}, 50%, 50%)`
                return background
            }
        }

        selectUser(e) {
            e.item.user.checked = e.target.checked
        }

        checkAll(e) {
            //console.log(e.target.checked);
            this.users.map(user=>user.checked = e.target.checked)
        }

        sortByField(event) {
            let label = event.item.label
            this.sortMode = this.sortMode.indexOf(label.name) == 0 ? `-${label.name}` : label.name
            let mode = this.sortMode.indexOf('-') == 0
            this.users.sort((a,b)=>{
                a = label.sort(a)
                b = label.sort(b)
                if (a < b)
                    return mode ? -1 : 1
                if (a > b)
                    return mode ? 1 : -1
                return 0
            })
        }

        this.sortMode = 'Nick'

        this.labels = [
            {name: 'Nick', sort: user=>user.profile.username.toUpperCase()},
            {name: 'Bezahlt', sort: user=>this.getUserRegdate(user)},
            {name: 'Mahnungen', sort: user=>user.warningsReceived},
            {name: 'Betrag', sort: user=>user.paysum},
            // {name: 'Items', sort: user=>user.items },
            {name: 'Rollen', sort: user=>user.attendeeRoles},
            {name: STATUS[STATUS_NEW], sort: user=>user.attendeeStatus==STATUS_NEW},
            {name: STATUS[STATUS_PENDING], sort: user=>user.attendeeStatus==STATUS_PENDING},
            {name: STATUS[STATUS_ACCEPTED], sort: user=>user.attendeeStatus==STATUS_ACCEPTED},
            {name: STATUS[STATUS_WAITING], sort: user=>user.attendeeStatus==STATUS_WAITING},
            {name: STATUS[STATUS_SIGNEDOFF], sort: user=>user.attendeeStatus==STATUS_SIGNEDOFF},
            {name: STATUS[STATUS_DISMISSED], sort: user=>user.attendeeStatus==STATUS_DISMISSED},
        ]

        this.moneyFormat = moneyFormat

        this.status = ['']
    </script>
</manage-registrations>
